cmake_minimum_required(VERSION 3.12)

project(nndeploy)

ENABLE_LANGUAGE(ASM C CXX)

set(NNDEPLOY_MAJOR_VERSION 1)
set(NNDEPLOY_MINOR_VERSION 0)
set(NNDEPLOY_PATCH_VERSION 0)
set(NNDEPLOY_BUILD_VERSION 0)
set(NNDEPLOY_VERSION "${NNDEPLOY_MAJOR_VERSION}.${NNDEPLOY_MINOR_VERSION}.${NNDEPLOY_PATCH_VERSION}.${NNDEPLOY_BUILD_VERSION}")

include(cmake/util.cmake)
include(cmake/summary.cmake)

if(EXISTS ${CMAKE_CURRENT_BINARY_DIR}/config_nndeploy.cmake)
  include(${CMAKE_CURRENT_BINARY_DIR}/config_nndeploy.cmake)
endif()
if(EXISTS ${CMAKE_CURRENT_BINARY_DIR}/config_nntask.cmake)
  include(${CMAKE_CURRENT_BINARY_DIR}/config_nntask.cmake)
endif()

# common
nndeploy_option(NNDEPLOY_ENABLE_BUILD_SHARED "NNDEPLOY_ENABLE_BUILD_SHARED" OFF)
nndeploy_option(NNDEPLOY_ENABLE_SYMBOL_HIDE "NNDEPLOY_ENABLE_SYMBOL_HIDE" OFF)
nndeploy_option(NNDEPLOY_ENABLE_COVERAGE "NNDEPLOY_ENABLE_COVERAGE" OFF)
nndeploy_option(NNDEPLOY_ENABLE_CXX11_ABI "NNDEPLOY_ENABLE_CXX11_ABI" ON)
nndeploy_option(NNDEPLOY_ENABLE_CXX14_ABI "NNDEPLOY_ENABLE_CXX14_ABI" OFF)
nndeploy_option(NNDEPLOY_ENABLE_CXX17_ABI "NNDEPLOY_ENABLE_CXX17_ABI" OFF)
nndeploy_option(NNDEPLOY_ENABLE_OPENMP "NNDEPLOY_ENABLE_OPENMP" OFF)
nndeploy_option(NNDEPLOY_ENABLE_OPENMP "NNDEPLOY_ENABLE_OPENMP" OFF)
nndeploy_option(NNDEPLOY_ENABLE_VALGRIND "NNDEPLOY_ENABLE_VALGRIND" OFF)
nndeploy_option(NNDEPLOY_ENABLE_DOCS "NNDEPLOY_ENABLE_DOCS" OFF)
# nndeploy
nndeploy_option(NNDEPLOY_ENABLE "NNDEPLOY_ENABLE" OFF)
## base
nndeploy_option(NNDEPLOY_ENABLE_BASE "NNDEPLOY_ENABLE_BASE" OFF)
## thread
nndeploy_option(NNDEPLOY_ENABLE_THREAD "NNDEPLOY_ENABLE_THREAD" OFF)
## cryption
nndeploy_option(NNDEPLOY_ENABLE_CRYPTION "NNDEPLOY_ENABLE_CRYPTION" OFF)
## device
nndeploy_option(NNDEPLOY_ENABLE_DEVICE "NNDEPLOY_ENABLE_DEVICE" OFF)
nndeploy_option(NNDEPLOY_ENABLE_DEVICE_CPU "NNDEPLOY_ENABLE_DEVICE_CPU" OFF)
nndeploy_option(NNDEPLOY_ENABLE_DEVICE_ARM "NNDEPLOY_ENABLE_DEVICE_ARM" OFF)
nndeploy_option(NNDEPLOY_ENABLE_DEVICE_X86 "NNDEPLOY_ENABLE_DEVICE_X86" OFF)
nndeploy_option(NNDEPLOY_ENABLE_DEVICE_CUDA "NNDEPLOY_ENABLE_DEVICE_CUDA" OFF)
nndeploy_option(NNDEPLOY_ENABLE_DEVICE_OPENCL "NNDEPLOY_ENABLE_DEVICE_OPENCL" OFF)
nndeploy_option(NNDEPLOY_ENABLE_DEVICE_OPENGL "NNDEPLOY_ENABLE_DEVICE_OPENGL" OFF)
nndeploy_option(NNDEPLOY_ENABLE_DEVICE_METAL "NNDEPLOY_ENABLE_DEVICE_METAL" OFF)
nndeploy_option(NNDEPLOY_ENABLE_DEVICE_APPLE_NPU "NNDEPLOY_ENABLE_DEVICE_APPLE_NPU" OFF)
nndeploy_option(NNDEPLOY_ENABLE_DEVICE_HVX "NNDEPLOY_ENABLE_DEVICE_HVX" OFF)
nndeploy_option(NNDEPLOY_ENABLE_DEVICE_MTK_VPU "NNDEPLOY_ENABLE_DEVICE_MTK_VPU" OFF)
## graph
nndeploy_option(NNDEPLOY_ENABLE_GRAPH "NNDEPLOY_ENABLE_GRAPH" OFF)
## audio
nndeploy_option(NNDEPLOY_ENABLE_AUDIO "NNDEPLOY_ENABLE_AUDIO" OFF)
nndeploy_option(NNDEPLOY_ENABLE_AUDIO_CORE "NNDEPLOY_ENABLE_AUDIO" OFF)
## cv
nndeploy_option(NNDEPLOY_ENABLE_CV "NNDEPLOY_ENABLE_CV" OFF)
nndeploy_option(NNDEPLOY_ENABLE_CV_CORE "NNDEPLOY_ENABLE_CV_CORE" OFF)
## inference
nndeploy_option(NNDEPLOY_ENABLE_INFERENCE "NNDEPLOY_ENABLE_INFERENCE" OFF)
nndeploy_option(NNDEPLOY_ENABLE_INFERENCE_DEFAULT "NNDEPLOY_ENABLE_INFERENCE_DEFAULT" OFF)
nndeploy_option(NNDEPLOY_ENABLE_INFERENCE_TENSORRT "NNDEPLOY_ENABLE_INFERENCE_TENSORRT" OFF)
nndeploy_option(NNDEPLOY_ENABLE_INFERENCE_OPENVINO "NNDEPLOY_ENABLE_INFERENCE_OPENVINO" OFF)
nndeploy_option(NNDEPLOY_ENABLE_INFERENCE_COREML "NNDEPLOY_ENABLE_INFERENCE_COREML" OFF)
nndeploy_option(NNDEPLOY_ENABLE_INFERENCE_TFLITE "NNDEPLOY_ENABLE_INFERENCE_TFLITE" OFF)
nndeploy_option(NNDEPLOY_ENABLE_INFERENCE_ONNXRUNTIME "NNDEPLOY_ENABLE_INFERENCE_ONNXRUNTIME" OFF)
nndeploy_option(NNDEPLOY_ENABLE_INFERENCE_NCNN "NNDEPLOY_ENABLE_INFERENCE_NCNN" OFF)
nndeploy_option(NNDEPLOY_ENABLE_INFERENCE_TNN "NNDEPLOY_ENABLE_INFERENCE_TNN" OFF)
nndeploy_option(NNDEPLOY_ENABLE_INFERENCE_MNN "NNDEPLOY_ENABLE_INFERENCE_MNN" OFF)
nndeploy_option(NNDEPLOY_ENABLE_AICOMPILER_TVM "NNDEPLOY_ENABLE_INFERENCE_TVM" OFF)
## test
nndeploy_option(NNDEPLOY_ENABLE_TEST "NNDEPLOY_ENABLE_TEST" OFF)
# nntask
nndeploy_option(NNTASK_ENABLE "NNTASK_ENABLE" OFF)
## test
nndeploy_option(NNTASK_ENABLE_TEST "NNTASK_ENABLE_TEST" OFF)
## demo
nndeploy_option(NNTASK_ENABLE_DEMO "NNTASK_ENABLE_DEMO" OFF)

# print option
print_summary()

# set
set(ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})

set_property(GLOBAL PROPERTY USE_FOLDERS ON)

# install path
set(NNDEPLOY_INSTALL_PATH ${ROOT_PATH}/build/install)
message(STATUS "NNDEPLOY_INSTALL_PATH: ${NNDEPLOY_INSTALL_PATH}")
if(NNDEPLOY_ENABLE_BUILD_SHARED)
  set(NNDEPLOY_INSTALL_TYPE LIBRARY)
else()
  set(NNDEPLOY_INSTALL_TYPE ARCHIVE)
endif()

if(NNDEPLOY_ENABLE_BUILD_SHARED)
  set(NNDEPLOY_LIB_TYPE SHARED)
  set(NNDEPLOY_LIB_TYPE SHARED)
else()
  set(NNDEPLOY_LIB_TYPE STATIC)
endif()

# define
if(CMAKE_BUILD_TYPE MATCHES "Debug")
  add_definitions(-DNNDEPLOY_DEBUG)
endif()

# general
set(NNDEPLOY_LIB_PREFIX "lib")
set(NNDEPLOY_LIB_SUFFIX ".so")
if(CMAKE_SYSTEM_NAME MATCHES "^Android")
  set(SYSTEM.Android 1)
elseif(CMAKE_SYSTEM_NAME MATCHES "^Linux")
  set(SYSTEM.Linux 1)
elseif(CMAKE_SYSTEM_NAME MATCHES "^Darwin")
  set(SYSTEM.Darwin 1)
elseif(CMAKE_SYSTEM_NAME MATCHES "^iOS")
  set(SYSTEM.iOS 1)
elseif(CMAKE_SYSTEM_NAME MATCHES "^Windows")
  set(SYSTEM.Windows 1)
  set(NNDEPLOY_LIB_SUFFIX ".dll")
endif()
set(NNDEPLOY_LIB_PATH)
if(CMAKE_SYSTEM_PROCESSOR MATCHES "^arm")
  set(PROCESSOR.arm 1)
  set(NNDEPLOY_LIB_PATH "lib/armeabi-v7a/Release")
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "^aarch64")
  set(PROCESSOR.aarch64 1)
  set(NNDEPLOY_LIB_PATH "lib/arm64-v8a/Release")
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "^x86")
  set(PROCESSOR.x86 1)
  set(NNDEPLOY_LIB_PATH "lib/x86/Release")
endif()

if(SYSTEM.Windows AND NNDEPLOY_ENABLE_BUILD_SHARED)
  add_definitions(-DNNDEPLOY_ENABLE_BUILDING_DLL)
endif()

if(NNDEPLOY_ENABLE_OPENMP)
  FIND_PACKAGE(OpenMP REQUIRED)

  if(OPENMP_FOUND)
    if(MSVC)
      set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} /openmp")
      set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /openmp")
    else()
      set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${OpenMP_C_FLAGS}")
      set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${OpenMP_CXX_FLAGS}")
      include_directories(${OpenMP_C_INCLUDE_DIRS} ${OpenMP_CXX_INCLUDE_DIRS})

      if(${ANDROID_NDK_MAJOR})
        if(${ANDROID_NDK_MAJOR} GREATER 20)
        else()
          link_libraries(${OpenMP_C_LIBRARIES} ${OpenMP_CXX_LIBRARIES})
        endif()
      else()
        link_libraries(${OpenMP_C_LIBRARIES} ${OpenMP_CXX_LIBRARIES})
      endif()
    endif()
  else()
    error("OpenMP Not Found.")
  endif()
endif()

if(UNIX)
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -pthread")
endif()

if(NNDEPLOY_ENABLE_CXX17_ABI)
  set(CMAKE_CXX_STANDARD 17)
  set(NNDEPLOY_ENABLE_CXX14_ABI OFF)
  set(NNDEPLOY_ENABLE_CXX11_ABI OFF)
endif()
if(NNDEPLOY_ENABLE_CXX14_ABI)
  set(CMAKE_CXX_STANDARD 14)
  set(NNDEPLOY_ENABLE_CXX11_ABI OFF)
endif()
if(NNDEPLOY_ENABLE_CXX11_ABI)
  set(CMAKE_CXX_STANDARD 11)
endif()

set(CMAKE_POSITION_INDEPENDENT_CODE ON)

if(NNDEPLOY_ENABLE_DEVICE_METAL OR NNDEPLOY_ENABLE_DEVICE_APPLE_NPU)
  # compile the file according to file type
  # add_compile_nndeploy_options(-x objective-c++)
  set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fobjc-arc -Wno-shorten-64-to-32")
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fobjc-arc -Wno-shorten-64-to-32 -Wno-null-character")
  set(CMAKE_OBJCXX_FLAGS "${CMAKE_OBJCXX_FLAGS} -x objective-c++ -fobjc-arc -Wno-shorten-64-to-32 -Wno-null-character")
endif()

if(SYSTEM.Linux AND CMAKE_SYSTEM_PROCESSOR MATCHES "arm" AND ANDROID_API_LEVAL)
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -D_GLIBCXX_USE_C99_MATH_TR1")
  add_definitions(-D__ANDROID_API__=${ANDROID_API_LEVAL})
endif()

if(NNDEPLOY_ENABLE_COVERAGE)
  if(CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fprofile-instr-generate -fcoverage-mapping")
  elseif(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -coverage -fprofile-arcs -ftest-coverage")
    set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -coverage -lgcov")
  endif()
endif()

# nndeploy
if(NNDEPLOY_ENABLE)
  add_subdirectory(nndeploy)
endif()

# nntask
if(NNTASK_ENABLE)
  add_subdirectory(nntask)
endif()